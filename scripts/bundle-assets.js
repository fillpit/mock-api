#!/usr/bin/env node

/**
 * Bundle static files into a TypeScript module
 * This eliminates the need for KV storage
 */

import { readFileSync, readdirSync, writeFileSync } from 'fs';
import { join } from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const PUBLIC_DIR = join(__dirname, '../public');
const OUTPUT_FILE = join(__dirname, '../src/static-assets.ts');

// MIME types mapping
const MIME_TYPES = {
    '.html': 'text/html; charset=utf-8',
    '.css': 'text/css; charset=utf-8',
    '.js': 'application/javascript; charset=utf-8',
    '.json': 'application/json',
    '.png': 'image/png',
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.svg': 'image/svg+xml',
    '.ico': 'image/x-icon',
};

function getMimeType(filename) {
    const ext = filename.substring(filename.lastIndexOf('.'));
    return MIME_TYPES[ext] || 'application/octet-stream';
}

function isBinary(filename) {
    const ext = filename.substring(filename.lastIndexOf('.'));
    return ['.png', '.jpg', '.jpeg', '.ico'].includes(ext);
}

console.log('ðŸ“¦ Bundling static files...\n');

const files = readdirSync(PUBLIC_DIR);
const assets = {};

for (const file of files) {
    const filePath = join(PUBLIC_DIR, file);
    const content = readFileSync(filePath);
    const mimeType = getMimeType(file);
    const binary = isBinary(file);

    if (binary) {
        // Encode binary files as base64
        assets[file] = {
            content: content.toString('base64'),
            contentType: mimeType,
            encoding: 'base64'
        };
    } else {
        // Store text files as-is
        assets[file] = {
            content: content.toString('utf-8'),
            contentType: mimeType,
            encoding: 'utf-8'
        };
    }

    console.log(`âœ“ Bundled ${file} (${mimeType})`);
}

// Generate TypeScript module
const tsContent = `/**
 * Static Assets Bundle
 * Auto-generated by scripts/bundle-assets.js
 * DO NOT EDIT MANUALLY
 */

export interface Asset {
    content: string;
    contentType: string;
    encoding: 'utf-8' | 'base64';
}

export const STATIC_ASSETS: Record<string, Asset> = ${JSON.stringify(assets, null, 2)};

export function getAsset(filename: string): Asset | null {
    return STATIC_ASSETS[filename] || null;
}

export function getAssetResponse(filename: string): Response | null {
    const asset = getAsset(filename);
    if (!asset) return null;

    let body: BodyInit;
    if (asset.encoding === 'base64') {
        // Decode base64 for binary files
        const binaryString = atob(asset.content);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        body = bytes;
    } else {
        body = asset.content;
    }

    return new Response(body, {
        headers: {
            'Content-Type': asset.contentType,
            'Cache-Control': 'public, max-age=3600',
        },
    });
}
`;

writeFileSync(OUTPUT_FILE, tsContent, 'utf-8');

console.log(`\nâœ… Bundle created: ${OUTPUT_FILE}`);
console.log(`ðŸ“Š Total files: ${files.length}`);
